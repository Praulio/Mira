# Discoveries - Project Mira

> Memoria dinámica entre iteraciones del Ralph Loop.

## Patrones Descubiertos
- **Ralph Loop en Factory:** Migrado de Claude Code a Droid Exec.
- **Clerk Auth Condicional:** Implementado patrón de inicialización condicional de Clerk basado en validez de API keys, permitiendo builds exitosos en desarrollo sin claves reales.

## Notas de Sesión
- **2026-01-14:** Configuración inicial del sistema Ralph con integración de skills de React.
- **2026-01-15:** Sesión 1.1: Setup del Proyecto.
  - **Next.js 16.1.2:** Instalado mediante `create-next-app@latest`. Usa Turbopack por defecto.
  - **Tailwind 4:** Configuración minimalista basada en `@tailwindcss/postcss`. No requiere `tailwind.config.ts`.
  - **ESLint Flat Config:** Implementado en `eslint.config.mjs`. Se añadieron ignores para `.factory`, `docs` y `specs`.
  - **React 19:** Incluido como dependencia base.
  - **Librerías Base:** Instaladas `lucide-react`, `clsx`, `tailwind-merge`.
  - **Bug Resuelto:** El instalador fallaba por nombre de proyecto con mayúsculas ("Mira"). Se usó un subdirectorio temporal para la creación y movimiento de archivos.
- **2026-01-15:** Sesión 1.2: Configuración de Clerk Auth.
  - **@clerk/nextjs 6.x:** Instalado y configurado con middleware de protección de rutas.
  - **Archivos creados:**
    - `middleware.ts`: Protección de rutas con bypass condicional si no hay keys válidas.
    - `.env.local` y `.env.example`: Variables de entorno para Clerk.
    - `app/sign-in/[[...sign-in]]/page.tsx`: Página de login con componente Clerk.
    - `app/sign-up/[[...sign-up]]/page.tsx`: Página de registro con componente Clerk.
  - **Patrón de Build Robusto:** Implementada verificación de validez de keys de Clerk (`pk_test_placeholder` vs keys reales) en `layout.tsx` y `middleware.ts`, permitiendo que el proyecto compile exitosamente en desarrollo local sin necesidad de obtener keys reales de Clerk dashboard.
  - **Layout actualizado:** `ClerkProvider` envuelve la app condicionalmente solo cuando hay keys válidas.
  - **Metadata actualizada:** Título y descripción reflejan "Mira Tasker".
- **2026-01-15:** Sesión 1.3: Setup de Base de Datos (Neon + Drizzle).
  - **Dependencias instaladas:**
    - `drizzle-orm`: ORM TypeScript-first para PostgreSQL.
    - `@neondatabase/serverless`: Driver serverless de Neon compatible con edge runtime.
    - `drizzle-kit` (dev): Herramientas CLI para migraciones y generación de schemas.
  - **Archivos creados:**
    - `drizzle.config.ts`: Configuración de Drizzle Kit para migraciones con dialect `postgresql`.
    - `db/index.ts`: Conexión serverless con Neon usando Pool. Incluye validación de `DATABASE_URL`.
  - **Variables de entorno:** Añadida `DATABASE_URL` a `.env.example` y `.env.local` (con placeholders).
  - **Patrón de Conexión:** Se usa `Pool` de `@neondatabase/serverless` para compatibilidad con edge runtime y serverless functions.
  - **Build Status:** ✅ Lint y build pasaron exitosamente sin errores.
- **2026-01-15:** Sesión 1.4: Implementación de Webhook de Clerk para User Sync.
  - **Dependencia instalada:**
    - `svix`: Librería oficial para validación de signatures de webhooks de Clerk.
  - **Archivos creados:**
    - `db/schema.ts`: Schema inicial con tabla `users` (id, email, name, imageUrl, slotIndex, timestamps).
    - `db/migrations/0000_classy_saracen.sql`: Primera migración SQL para crear tabla users.
    - `app/api/webhooks/clerk/route.ts`: Endpoint POST que maneja eventos `user.created` y `user.updated`.
    - `db/README.md`: Guía para ejecutar migraciones con Drizzle Kit.
  - **Archivos actualizados:**
    - `db/index.ts`: Importado schema para habilitar queries tipadas con Drizzle.
    - `.env.example`: Añadida variable `CLERK_WEBHOOK_SECRET` con instrucciones.
  - **Patrón de Webhook:** Validación de firma Svix en headers (`svix-id`, `svix-timestamp`, `svix-signature`), manejo de eventos con insert/update en DB, logs de errores en consola.
  - **Seguridad:** El webhook verifica la firma antes de procesar cualquier payload, previniendo requests no autorizados.
  - **Build Status:** ✅ Lint y build pasaron exitosamente. Ruta `/api/webhooks/clerk` visible en manifest de Next.js.
- **2026-01-15:** Sesión 2.1: Definición completa del Schema de Base de Datos.
  - **Schema actualizado:** Se añadieron tablas `tasks` y `activity` a `db/schema.ts`.
  - **Enums creados:**
    - `taskStatusEnum`: Define los 4 estados posibles de una tarea (backlog, todo, in_progress, done).
    - `activityActionEnum`: Define los tipos de eventos a registrar (created, status_changed, assigned, updated, deleted).
  - **Tabla tasks:** 
    - Campos: id (UUID), title, description, status (enum), assigneeId (FK nullable), creatorId (FK required), timestamps.
    - Foreign Keys: assigneeId y creatorId referencian a `users.id` con `onDelete: set null` y `cascade` respectivamente.
    - Índices: `tasks_assignee_idx`, `tasks_status_idx`, `tasks_creator_idx` para optimizar queries frecuentes.
  - **Tabla activity:**
    - Campos: id (UUID), taskId (FK nullable), userId (FK required), action (enum), metadata (JSONB), createdAt.
    - Foreign Keys: taskId referencia `tasks.id` y userId referencia `users.id`, ambos con `cascade`.
    - Índices: `activity_task_idx`, `activity_created_at_idx`, `activity_user_idx` para queries de histórico.
    - Metadata JSONB permite almacenar información adicional como old/new status en transiciones.
  - **Scripts de DB añadidos:** 
    - Instalado `dotenv-cli` para cargar variables de entorno en comandos de Drizzle Kit.
    - Scripts en `package.json`: `db:generate`, `db:push`, `db:studio`.
  - **Migración generada:** `db/migrations/0001_brave_moonstone.sql` contiene la creación de enums, tablas, foreign keys e índices.
  - **Patrón de Índices:** Se priorizan índices en columnas usadas frecuentemente en WHERE y JOIN clauses (assignee, status, created_at).
  - **Build Status:** ✅ Lint pasó con 1 warning no relacionado (middleware.ts), build completado exitosamente en 919ms. Schema compila sin errores TypeScript.
- **2026-01-15:** Sesión 2.2: Server Action - createTask.
  - **Zod 4.3.5:** Ya instalado como dependencia transitiva de `eslint-plugin-react-hooks`. No requirió instalación adicional.
  - **Archivo creado:**
    - `app/actions/tasks.ts`: Server Action para crear tareas con validación Zod, logging de actividad y revalidación de rutas.
  - **Patrón de Server Actions:**
    - Directiva `'use server'` al inicio del archivo.
    - Tipo estandarizado `ActionResponse<T>` con campos `success`, `data?`, `error?`.
    - Autenticación con `auth()` de Clerk antes de cualquier operación.
    - Validación de input con `safeParse()` de Zod, retornando el primer error de validación.
    - Manejo de errores con try-catch y logs en consola.
    - Uso de `revalidatePath()` para invalidar cache de rutas relevantes (/, /kanban, /backlog).
  - **Schema de Validación:**
    - `title`: String requerido, máximo 200 caracteres.
    - `description`: String opcional, máximo 2000 caracteres.
    - `assigneeId`: String opcional para asignar la tarea a un usuario.
  - **Lógica de Creación:**
    - Status por defecto: `'backlog'` (definido en schema de DB).
    - Inserción en tabla `tasks` con `.returning()` para obtener el registro creado.
    - Inserción en tabla `activity` con action `'created'` y metadata con título y assigneeId.
  - **Bug Resuelto:** Error TypeScript inicial al usar `validationResult.error.errors[0]` en Zod 4.x. La propiedad correcta es `validationResult.error.issues[0]` en versiones modernas de Zod.
  - **Build Status:** ✅ Lint pasó con 1 warning no relacionado (middleware.ts). Build completado exitosamente en 829ms. TypeScript compila sin errores.
- **2026-01-15:** Sesión 2.3: Server Action - updateTaskStatus (Lógica Crítica).
  - **Archivo actualizado:**
    - `app/actions/tasks.ts`: Añadida función `updateTaskStatus` con transacción atómica para implementar la regla de "Single In-Progress Task".
  - **Imports adicionales:** `eq` y `and` de `drizzle-orm` para queries condicionales.
  - **Schema de Validación:**
    - `taskId`: String UUID requerido.
    - `newStatus`: Enum con valores válidos ('backlog', 'todo', 'in_progress', 'done').
  - **Lógica de Single In-Progress Task:**
    1. Fetch de la tarea actual para obtener su assigneeId y status previo.
    2. Transacción atómica con `db.transaction()`:
       - Si `newStatus === 'in_progress'` y la tarea tiene assigneeId, ejecuta un UPDATE masivo moviendo TODAS las tareas `in_progress` del mismo assignee a `todo`.
       - Actualiza la tarea target con el nuevo status.
       - Inserta registro en tabla `activity` con action `'status_changed'` y metadata conteniendo oldStatus, newStatus y taskTitle.
    3. Revalidación de rutas (/, /kanban, /backlog).
  - **Patrón de Transacción:** Uso de `db.transaction(async (tx) => {})` de Drizzle para garantizar atomicidad. Si cualquier operación falla, todas se revierten automáticamente.
  - **Manejo de Edge Cases:**
    - Si la tarea no existe, retorna error `'Task not found'` antes de ejecutar la transacción.
    - Si la tarea no tiene assigneeId, no ejecuta la lógica de single-in-progress (permite múltiples tareas in_progress no asignadas).
  - **Activity Logging:** Metadata incluye `oldStatus`, `newStatus` y `taskTitle` para trazabilidad completa de cambios de estado.
  - **Build Status:** ✅ Lint pasó con 1 warning no relacionado (middleware.ts). Build completado exitosamente en 981ms con Turbopack. TypeScript compila sin errores. Función exportada correctamente como Server Action.
- **2026-01-15:** Sesión 2.4: Unit Tests para Lógica de Estados.
  - **Dependencias instaladas:**
    - `vitest@4.0.17`: Framework de testing rápido compatible con Vite/Next.js.
    - `@vitest/ui@4.0.17`: Interfaz web para visualización de tests.
    - `happy-dom@20.3.0`: Environment DOM ligero para tests (más rápido que jsdom).
  - **Archivos creados:**
    - `vitest.config.ts`: Configuración de Vitest con environment `happy-dom` y alias `@/` para imports absolutos.
    - `app/actions/__tests__/tasks.test.ts`: Suite de 9 tests unitarios para `updateTaskStatus`.
  - **Scripts añadidos:**
    - `test`: Ejecuta tests en modo CI (single run).
    - `test:watch`: Ejecuta tests en modo watch.
    - `test:ui`: Abre interfaz web de Vitest.
  - **Cobertura de Tests (9 tests, 100% passed):**
    1. **Authentication:** Rechaza requests sin autenticación.
    2. **Input Validation:** Rechaza UUIDs inválidos y status no permitidos.
    3. **Single In-Progress Logic (CRITICAL):**
       - Mueve otras tareas `in_progress` a `todo` cuando se activa una nueva.
       - NO mueve tareas si el nuevo status no es `in_progress` (ej: moving to `done`).
       - Maneja tareas sin assigneeId gracefully (skip lógica single-in-progress).
    4. **Error Handling:** Retorna error cuando la tarea no existe.
    5. **Transaction Errors:** Maneja fallos de DB con error message amigable.
    6. **Activity Logging:** Verifica que se inserte registro en tabla `activity`.
  - **Patrón de Testing:**
    - Mocking de módulos externos: `@clerk/nextjs/server`, `next/cache`, `@/db`.
    - Uso de tipos explícitos para mocks (`type MockTx`) en vez de `any` para cumplir con linting.
    - `beforeEach` para resetear mocks y configurar estado default (usuario autenticado).
    - `afterEach` para limpiar mocks.
  - **Bug Resuelto durante Lint:**
    - Variables no utilizadas `otherTaskId1` y `otherTaskId2` removidas.
    - Tipos `any` reemplazados por tipo explícito `MockTx` con definición de propiedades.
    - Parámetro `table` no utilizado removido de mock de `insert()`.
  - **Build Status:** ✅ 9/9 tests passed. Lint pasó (solo 1 warning pre-existente en middleware.ts). Build completado exitosamente en 1049ms. TypeScript compila sin errores.
- **2026-01-15:** Sesión 2.5: Server Actions - deleteTask y updateTaskMetadata.
  - **Archivo actualizado:**
    - `app/actions/tasks.ts`: Añadidas dos nuevas Server Actions con validación Zod, transacciones atómicas y activity logging.
  - **Schemas de Validación:**
    - `deleteTaskSchema`: Valida UUID del taskId.
    - `updateTaskMetadataSchema`: Valida taskId (UUID), title opcional (1-200 chars), description opcional (0-2000 chars). Incluye refinamiento Zod para garantizar que al menos un campo sea provisto.
  - **deleteTask:**
    - Verifica autenticación con Clerk.
    - Fetch de la tarea para verificar existencia y capturar metadata antes de borrado.
    - Transacción atómica: Inserta registro en `activity` con action `'deleted'` y metadata (title, status, assigneeId) ANTES de ejecutar el DELETE.
    - El DELETE en DB usa CASCADE (definido en schema) para eliminar automáticamente registros relacionados en `activity`.
    - Revalidación de rutas (/, /kanban, /backlog).
  - **updateTaskMetadata:**
    - Permite actualización parcial de title y/o description.
    - Fetch de la tarea para obtener valores previos (oldTitle, oldDescription).
    - Construye objeto `updateData` dinámicamente incluyendo solo campos provistos.
    - Transacción atómica: UPDATE de la tarea + INSERT en activity con metadata completa (old/new values, fieldsUpdated flags).
    - Revalidación de rutas (/, /kanban, /backlog).
  - **Patrón de Activity Logging:**
    - `deleteTask`: Logs ANTES del DELETE para preservar referencia al taskId antes de CASCADE.
    - `updateTaskMetadata`: Logs metadata con comparación old vs new para trazabilidad completa de cambios.
  - **Build Status:** ✅ Lint pasó (1 warning pre-existente). Build completado exitosamente en 1043ms con Turbopack. Tests existentes (9/9) siguen pasando. TypeScript compila sin errores.
- **2026-01-15:** Sesión 3.1: Layout Principal y Navigation.
  - **Shadcn/ui Instalado:**
    - Ejecutado `npx shadcn@latest init` con estilo "new-york", baseColor "neutral", y modo RSC habilitado.
    - Configuración generada en `components.json` con aliases para `@/components`, `@/lib`, `@/hooks`.
    - Instalado componente `button` de shadcn.
    - Archivo creado: `lib/utils.ts` con función helper `cn()` (classNames merge con tailwind-merge).
  - **Estructura de Rutas:**
    - Creado route group `app/(dashboard)` para páginas autenticadas.
    - Directorio `app/(dashboard)/dashboard` para rutas principales.
  - **Componentes creados:**
    - `components/sidebar.tsx`: Sidebar fijo de 64px con navegación hacia 4 vistas (Team View, Kanban, Backlog, Activity). Incluye highlighting del item activo basado en `usePathname()`.
    - `components/user-nav.tsx`: Wrapper client component para `UserButton` de Clerk con configuración de avatarBox.
    - `app/(dashboard)/layout.tsx`: Layout con sidebar fijo y área de contenido con top bar (título + UserButton). Usa `pl-64` para compensar sidebar fijo.
  - **Páginas placeholder creadas:**
    - `app/(dashboard)/dashboard/page.tsx`: Team View con grid de 8 slots vacíos (preparado para Task 3.2).
    - `app/(dashboard)/dashboard/kanban/page.tsx`: Kanban con 4 columnas placeholder (preparado para Task 4.1).
    - `app/(dashboard)/dashboard/backlog/page.tsx`: Backlog con lista vertical placeholder.
    - `app/(dashboard)/dashboard/activity/page.tsx`: Activity feed con 10 items placeholder (preparado para Task 5.1).
  - **Rutas configuradas:**
    - `/dashboard` → Team View (8-slot grid).
    - `/dashboard/kanban` → Kanban Board.
    - `/dashboard/backlog` → Backlog List.
    - `/dashboard/activity` → Activity Feed.
    - `/` → Redirige a `/dashboard` si autenticado, o `/sign-in` si no.
  - **Patrón de Dynamic Rendering:**
    - Todas las páginas del dashboard incluyen `export const dynamic = 'force-dynamic'` para evitar pre-rendering durante build, ya que requieren autenticación y datos de usuario.
    - Esto permite que el build pase exitosamente incluso sin Clerk keys válidas (usando el patrón condicional de ClerkProvider del layout raíz).
  - **Diseño implementado:**
    - Dark mode por defecto con colores neutral.
    - Sidebar con logo "M", navegación con iconos Lucide y descripciones de cada vista.
    - Footer en sidebar con versión "Mira Tasker v1.0.0".
    - Top bar sticky con título y UserButton.
  - **Bug Resuelto:**
    - Error de build: `UserButton can only be used within <ClerkProvider />`. Solución: Extraer UserButton a componente client separado (`user-nav.tsx`) e importarlo en el layout server component.
    - Warning de eslint: Variable `request` no utilizada en middleware.ts. Solución: Removido import `NextRequest` y parámetro del fallback middleware.
    - Agregado `/` a rutas públicas en middleware para permitir acceso durante build.
  - **Build Status:** ✅ Lint pasó sin warnings. Build completado exitosamente en 932ms con Turbopack. 9 rutas generadas correctamente (/, sign-in, sign-up, dashboard, kanban, backlog, activity, api/webhooks, 404). TypeScript compila sin errores.
